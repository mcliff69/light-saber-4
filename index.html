<html>
  <head>
    <meta charset="utf-8">
  </head>
<body>

<h1>СВЕТОВОЙ МЕЧ НА WEMOS, MP3 PLAYER И АДРЕСНЫХ СВЕТОДИОДАХ!</h1>

<h2>Общая информация</h2>
<p>
    В проекте представлен световой меч джидая из кинофильма Звёздные войны с дополнительными режимами.
</p>
<p>
    Меч светится разными цветами, мерцает, издает непрерывное гудение и звуки взмаха и удара. Вспыхивает при ударе. Воспроизводит произвольную фразу принажатии кнопки. При включении и выключении воспроизводит соответствующие звуки. Эти и другие звуки, цвета, громкость можно настроить в процессе работы кнопками.
</p>
<p>
    Имеет также режимы автомата (стреляет одиночными выстрелами или очередью, когда "заканчиваются" патроны нужно "перезарядить" обойму), факела (горит различными цветами и звуками пламени, можно усилить пламя), полицейской мигалки (с разными вариантами мигания и разными звуками сирены), жезла ДПС, просто лампы. Прошивку можно обновить, не разбирая меч.
</p>
<p>
    За основу был взят проект светового меча от Алекса Гайвера. Но код и железо сильно модифицированы, так что от исходного проекта мало что осталось.
</p>

<h2>Особенности реализации</h2>
<p>
    Был выбран контроллер Wemos D1 mini v3.0. Это снимает ограничения на объем кода и позволяет реализовать много дополнительных режимов и разных вариантов поведения меча. Более мощный процессор позволяет добавить более интересные световые эффекты. Наличие Wi-Fi позволяет обновлять прошивку по воздуху (OTA), не разбирая сам меч. Кроме того, звуки воспроизводятся через два mp3 плеера YX5300. Один используется для фонового звука. Второй для разных звуковых эффектов. Это упрощает код и позволяет избавиться от переходных процессов при переключении звуков. В отличии от предыдущей версии, где использовался DFPlayer, эти плееры могут воспроизводить WAV файлы. Поэтому уменьшается задержка между ударом и звуком удара. И нет паузы и щелчков при циклическом воспроизведении, например фона.
</p>
<p>
    Адресная лента используется WS2812B на 5 Вольт. Каждый LED управляется отдельно, в отличии от 12 В ленты, где LED-ы сгруппированы по 3. Это дает более плавную картинку, например в режиме ФАКЕЛ. А также позволяет использовать только два аккумулятора вместо трёх.
</p>
<p>
    В данной схеме я использовал DC-DC понижающий преобразователь LM2596HVS. При желании, его можно убрать. Тогда надо оставить только один аккумулятор (или несколько, соединенных параллельно), поменять сопротивление 470кОм на 220кОм (делитель для измерения напряжения аккумулятора), исправить в коде этот номинал, а также поменять количество банок аккумулятора с 2 на 1. Но когда я пробовал такой вариант, при разрядке аккумулятора начинали искажаться громкие звуки.
</p>
<p>
    Убрал отдельный светодиод на кнопке. Использовал вместо него первый светодиод ленты. Им можно моргать в разных случаях разным цветом. Сразу понятно, в каком режиме сейчас меч.
</p>
<p>
    Пришлось добавить сопротивление R2 10кОм, которое подтягивает вход D0 на питание. В контроллере на этом пине нет внутреннего подтягивающего сопротивления.
</p>
<p>
    Лента питается отдельным достаточно толстым проводом. Также добавил конденсатор большой емкости, чтобы убрать скачки по питанию, например при ударе, когда меч вспыхивает белым. Его использование необходимо, в отличии от 12 В ленты, где ток в 3 раза меньше.
</p>
<p>
    В mp3 плеерах разъемы наушников выпаял, чтобы не занимали пространство. Левый и правый каналы обоих плееров соединил и подал на вход усилителя. Так можно делать, потому что на выходах у плееров уже есть RC цепочки.
</p>
<p>
    В отличии от предыдущей версии, управление кнопками теперь более удобное и логичное.
</p>


<h2>Управление и основные возможности меча</h2>
<h3>Включение питания.</h3>
<p>
       <b>1. Нажимаем кнопку питания.</b> Лента плавно загорается красным на 2 сек, показывая процент зарядки аккумулятора. Включается дежурный режим. Первый светодиод моргает синим.
</p>
<p>
       <b>2. Во время включения питания нажата кнопка 1.</b> Включается режим прошивки кода по wifi (OTA). 
      Первый светодиод моргает оранжевым. Для корректной работы режима нужно подставить в коде WIFI_SSID и WIFI_PWD для входа в Вашу сеть WIFI. Для загрузки прошивки зайдите в браузере на 
      http://IP_ADDRESS/update , где IP_ADDRESS - IP адрес контроллера в сети. Его можно найти в админке маршрутизатора. Компьютер должен быть в той же сети (подключен к тому же маршрутизатору).
</p>
<p>
       <b>3. Заряд аккумулятора меньше 10%.</b> Ничего не работает, только первый светодиод моргает красным.
</p>
      
<h3>В дежурном режиме.</h3>
<p>
       <b>1. Длительное нажатие кнопок 1 + 2.</b> Включение меча (переход в рабочий режим). Если заряд меньше 10%, то не включается. Если выбран режим МЕЧ, то плавно загорается и проигрывается звук включения. Если звук долгий, его можно прервать кнопкой 2 или ударом меча.
</p>
<p>
      <b>2. Нажатие кнопок 1 + 2 более 3 секунд.</b> Настройка звука включения (только если выбран режим МЕЧ). Первый светодиод моргает зеленым. В этом режиме однократное нажатие кнопок 1/2 выбирает следующий/предыдущий звук включения. Выбранный звук проигрывается. Если не было нажатий 5 секунд, переходит в рабочий режим, выбранный звук запоминается.
</p>
<p>
      <b>3. Клик кнопки 1 или 2.</b> Неправильная попытка включить меч. Воспроизводится шуточное сообщение.
</p>
<p>
      <b>4. Удар или взмах в дежурном режиме.</b> Неправильное использование меча. Шуточное сообщение.
</p>
<p>
      <b>5. В дежурном режиме через 10 минут.</b> Воспроизводится напоминание, что нужно выключить питание. Дальше напоминание повторяется каждую минуту.
</p>


<h3>В рабочем режиме.</h3>
<p>
      <b>1. Длительное нажатие кнопок 1 + 2.</b> Выключение меча, переход в дежурный режим. Если выбран режим МЕЧ, то лента плавно гасится и проигрывается звук выключения. Первый светодиод моргает синим.
</p>
<p>
      <b>2. Нажатие кнопок 1 + 2 более 3 секунд.</b> Настройка звука выключения (только если выбран режим МЕЧ). Первый светодиод моргает зеленым. В этом режиме однократное нажатие кнопок 1/2 выбирает следующий/предыдущий звук выключения. Выбранный звук проигрывается. Если не было нажатий 5 секунд, переходит в дежурный режим, выбранный звук запоминается.
</p>
<p>
      <b>3. Клик кнопки 1.</b> В режиме МЕЧ, ЛАМПА переключает цвет по кругу (Красный - Оранжевый - Жёлтый - Зелёный - Голубой - Синий - Фиолетовый - Белый). В режиме АВТОМАТ переключает цвет выстрела. В режиме ФАКЕЛ меняет палитру огня. В режиме МИГАЛКА переключает вариант мигания.
</p>
<p>
      <b>4. Двойной клик кнопки 1.</b> В режиме МЕЧ, ФАКЕЛ переключает фоновый звук. В режиме АВТОМАТ переключает звук выстрела. В режиме МИГАЛКА переключает звук сирены.
</p>
<p>
      <b>5. Тройной клик кнопки 1.</b> Переход на следующий режим по кругу:
      МЕЧ - АВТОМАТ - ФАКЕЛ - МИГАЛКА - ЖЕЗЛ - ЛАМПА
</p>
<p>
      <b>6. Клик кнопки 2.</b> В режиме МЕЧ воспроизводит произвольную фразу из набора 1. В режиме АВТОМАТ воспроизводит выстрел. Траектория пули подсвечивается. Отрисовываеется пламя из дула. Если кончились патроны, воспроизводит щелчок. В режиме МИГАЛКА воспроизводит звук полицейской машины "Кря".
</p>
<p>
      <b>7. Двойной клик кнопки 2.</b> В режиме МЕЧ воспроизводит произвольную фразу из набора 2. В режиме АВТОМАТ перезаряжает обойму автомата. В режиме МИГАЛКА воспроизводит звук полицейской машины "Кря - кря".
</p>
<p>
      <b>8. Длительное нажатие кнопки 2.</b> В режиме АВТОМАТ - стрельба очередью. В режиме ФАКЕЛ - усиление пламени. В режиме МИГАЛКА - звук полицейской сирены.
</p>
<p>
      <b>9. Клик кнопки 1 при нажатой кнопке 2 / Клик кнопки 2 при нажатой кнопке 1.</b> Громче / тише (кроме режимов ЛАМПА, ЖЕЗЛ). Длина зеленой полосы показывает уровень громкости. 
</p>
<p>
      <b>10. Удар в режиме МЕЧ.</b> Звук удара из набора 1. Вспышка.
</p>
<p>
      <b>11. Удар с нажатой кнопкой 1 в режиме МЕЧ.</b> Звук удара из набора 2. Вспышка.
</p>
<p>
      <b>12. Удар с нажатой кнопкой 2 в режиме МЕЧ.</b> Звук удара из набора 3. Вспышка.
</p>
<p>
      <b>13. Взмах в режиме МЕЧ.</b> Звук взмаха.
</p>
<p>
      <b>14. Резкий взмах в режиме МЕЧ.</b> Звук резкого взмаха.
</p>
<p>
      <b>15. Если пользователь ничего не нажимает (не машет, не ударяет) 10 минут.</b> Переходит в дежурный режим.
</p>
<p>
      <b>16. Если аккумулятор разряжается в процессе работы.</b> Проигрывается звук умирающего меча. Всё выключается. Первый светодиод моргает красным.
</p>
<p>
      Выбранные настройки (режим работы меча, цвет меча, палитра огня, цвет выстрела, цвет лампы, вариант полицейской мигалки, громкость, звук включения, звук выключения, звук фона меча, звук фона факела, звук выстрела, звук сирены) сохраняются в энергонезависимой памяти и восстанавливаются при следующем включении. 
</p>


<h2>Схема</h2>
<p>
<img src="images/scheme.png" width="100%"/>
</p>

<h2>Ресурсы</h2>
<p>
    Исходный проект меча от Алекса Гайвера.
    <br>
    <a href="https://alexgyver.ru/arduino-lightsaber/" target="_blank">Версия Алекса Гайвера</a> 
</p>
<p>
    Моя предыдущая версия меча.
    <br>
    <a href="https://github.com/mcliff69/warstarsaber" target="_blank">Версия 2.0</a> 
</p>
<p>
    Исходный проект мигалки. Код полностью переработан.
    <br>
    <a href="https://github.com/neuroraddiy/fastled-police-strobo" target="_blank">fastled-police-strobo</a> 
</p>
<p>
    Звуки брал на различных сайтах, например:
    <br>
    <a href="https://freesound.org/" target="_blank">https://freesound.org/</a>
    <br>
    <a href="https://audionerd.ru/" target="_blank">https://audionerd.ru/</a>
</p>
<p>
    А здесь можно сгенерировать озвучку произвольного текста:
    <br>
    <a href="https://cloud.yandex.ru/services/speechkit" target="_blank">https://cloud.yandex.ru/services/speechkit</a>
</p>
<p>
    Для конвертации в WAV формат использовал утилиту
    <br>
    <a href="http://ffmpeg.org/" target="_blank">FFMPEG</a>
</p>
<p>
    Для редактирования (перевод в моно, нормализация громкости, обрезание лишних фрагментов и пауз) аудио-редактор 
    <br>
    <a href="https://www.audacityteam.org/" target="_blank">Audacity</a>
</p>
<p>
    Схему рисовал в редакторе схем
    <br>
    <a href="https://fritzing.org/" target="_blank">Fritzing</a>
</p>
<p>
    Кастомные компоненты для Fritzing рисовал в SVG редакторе
    <br>
    <a href="https://inkscape.org/ru/" target="_blank">Inkscape</a>
</p>



<h2>Детали</h2>

<p>
<a href="https://aliexpress.ru/item/32643142716.html" target="_blank">Wemos D1 Mini v3.0</a>
</p>

<p>
<a href="https://aliexpress.ru/item/32503791205.html" target="_blank">MPU6050 акселерометр</a>
</p>

<p>
<a href="https://aliexpress.ru/item/33012305839.html" target="_blank">Модуль MP3-плеера YX5300</a>
</p>

<p>
<a href="https://aliexpress.ru/item/32864725628.html" target="_blank">SD карты</a>
</p>

<p>
<a href="https://aliexpress.ru/item/32517870014.html" target="_blank">Понижающий DC-DC преобразователь LM2596HVS</a>
</p>

<p>
<a href="https://aliexpress.ru/item/32574110297.html" target="_blank">Усилитель мощности PAM8403</a> или
<a href="https://aliexpress.ru/item/32966550225.html" target="_blank">на 5Вт</a>
</p>

<p>
<a href="https://aliexpress.ru/item/4000168061181.html" target="_blank">Светодиодная адресная лента WS2811</a> нужна белая, без защиты (IP30), 60 led/m
</p>

<p>
<a href="https://aliexpress.ru/item/32360453063.html" target="_blank">Аккумы LiitoKala NCR18650B</a>
</p>

<p>
<a href="https://aliexpress.ru/item/32816148353.html" target="_blank">Кнопки управления</a>
</p>

<p>
<a href="https://aliexpress.ru/item/4000478357979.html" target="_blank">Кнопка питания</a> нужен вариант с защелкой
</p>

<p>
<a href="https://aliexpress.ru/item/32838402044.html" target="_blank">Разъём для зарядки 2,1x5,5 мм</a>
</p>

<p>
<a href="https://aliexpress.ru/item/4000727738606.html" target="_blank">Динамик 40мм 4Ом 5Вт</a>
</p>

<p>
<a href="https://aliexpress.ru/item/32575817765.html" target="_blank">Макетки</a>
</p>

<p>
<a href="http://energoplast.ru/" target="_blank">Белая труба для лезвия</a> самовывоз из Москвы. Нужна труба 32мм с внутренней крышкой
</p>

<p>
Рукоятка сделана из сантехнической трубы диаметром 40мм длиной 250 мм. В верхний конец вставлен раструб от сантехнической трубы диаметром 32мм, в который вставляется белая труба (лезвие меча). В нижний конец (то есть в раструб) вставлен отрезок такой же трубы (40 мм), чтобы утопить кнопку питания и разъем зарядки.
</p>

<p>
Динамик лежит на уплотнительной резинке трубы. Поверх него положил защитную сетку - обрезанная до 40 мм сетка для раковины из нержавейки. Край закрепил силиконом.
</p>


</body>
</html>
